# 第一階段：每日全量同步與基準建立系統 - 執行計畫說明

## 1. 專案目標
建立庫存數據的「黃金基準 (Golden Master)」。此階段程式負責執行最完整、最嚴謹的資料抓取與驗證，確保本地資料庫與 Google Sheets 擁有最正確的商品清單與庫存狀態，作為第二階段快速查詢的基礎。

## 2. 核心原則
*   **完整性優先**：不計耗時，必須下載所有平台的所有商品。
*   **嚴謹過濾**：針對 Yahoo 商品進行逐筆 `endTs` (下架時間) 檢查，確保過期商品不進入系統。
*   **數據清洗**：執行 SKU 格式化 (去除規格中的中文字)，統一跨平台對照標準。
*   **基準建立**：將清洗後的正確資料寫入本地資料庫與 Google Sheets。

## 3. 功能架構 (V5.5 版本)

### A. 資料下載與過濾 (Data Fetching & Filtering)
*   **Yahoo**:
    *   下載全賣場商品清單。
    *   **[關鍵步驟]** 針對每一筆商品，呼叫 Listing API 查詢 `endTs`。
    *   **[過濾規則]** 若 `endTs` < 系統時間，視為過期，直接丟棄。
    *   **[SKU 規則]**
        *   若規格名稱含「尺寸」：
            *   剔除規格值中的中文字 (保留英文與數字)。
            *   **SKU = partNo + "/" + spec_value** (例: "2040076-61" + "L" -> "2040076-61/L")。
        *   若規格名稱**不含**「尺寸」：
            *   **SKU = partNo**。
*   **Momo**:
    *   下載全賣場商品清單。
    *   **[SKU 規則]**
        *   基礎 SKU = `entp_goods_no` (原廠料號)。
        *   檢查 `goodsdt_info` (規格)：
            *   若包含 **"/"**：取 **"/"** 後面的字串，並剔除中文字 (保留英數)。
                *   **SKU = entp_goods_no + "/" + processed_suffix**。
            *   若**不含** **"/"** (例如 "無", "深灰(1220)")：
                *   **SKU = entp_goods_no**。
    *   **[狀態過濾]**
        *   檢查 `sale_gb_name` (販售狀態)：
        *   **保留**：「進行」、「暫時中斷」。
        *   **過濾**：「永久中斷」。
    *   **[庫存擷取]**
        *   針對篩選後的產品，批次呼叫庫存 API 取得數量 (`stock_quantity`)。
*   **PChome**:
    *   下載全賣場商品清單。
    *   **[未來規劃]** 待 Yahoo API 測試穩定後，將追加此平台的產品篩選邏輯。

### B. 資料庫與報表更新 (DB & Reporting)
*   **本地資料庫 (`inventory.db`)**:
    *   將所有「有效商品」寫入資料庫。
    *   此資料庫將成為第二階段 (快速查詢) 的唯一信任來源。
*   **Google Sheets**:
    *   將所有「有效商品」及其詳細資訊 (包含 Yahoo 原始料號、處理後 SKU、各平台庫存) 寫入雲端報表。

## 4. 執行步驟 (Workflow)

1.  **啟動與驗證**
    *   程式啟動 (`InventorySync_V5.5.exe`)。
    *   驗證 API 金鑰與 Google Sheets 連線。
2.  **全量下載 (最耗時)**
    *   並行下載 Yahoo, Momo, PChome 資料。
    *   執行 Yahoo `endTs` 逐筆檢查 (N+1 查詢)。
3.  **資料清洗與寫入**
    *   格式化 SKU。
    *   更新 `inventory.db`。
    *   更新 Google Sheets。
4.  **結束**
    *   產出執行 Log (`sync.log`)。
    *   產出執行 Log (`sync.log`)。

## 5. 預期效益
*   **資料準確**：排除所有過期與無效商品。
*   **統一標準**：建立跨平台一致的 SKU 對照。
*   **營運基石**：為第二階段提供乾淨、可信的資料來源。
