# V5.0 技術文件

## 📋 概述

**版本**: 5.0  
**發布日期**: 2025-12-03  
**主要目標**: 解決 Yahoo 產品重複問題，實現精準的跨平台庫存同步

---

## 🎯 核心問題

### 問題描述
在 V4.5 版本中，發現 Yahoo 產品存在重複記錄問題：
- **現象**: 同一個 Part No 在 Yahoo 有 2 筆記錄，在 MOMO 只有 1 筆
- **原因**: Yahoo 產品有「上架中」和「已下架（過期）」兩種狀態
- **影響**: 庫存比對不準確，同步邏輯錯誤

### 解決方案
通過 Yahoo Listing API 的 `endTs` 欄位判斷產品是否過期：
```javascript
{
  "endTs": "2024-11-15T23:59:59Z",  // 下架時間
  "startTs": "2024-01-01T00:00:00Z", // 上架時間
  "status": "offline"                // 狀態
}
```

**判斷邏輯**:
```python
if endTs < current_time:
    # 產品已過期，不納入同步
    is_expired = True
```

---

## 🏗️ 系統架構

### 核心組件

```
┌─────────────────────────────────────────────────────────┐
│                    InventorySync V5                      │
├─────────────────────────────────────────────────────────┤
│                                                          │
│  ┌──────────────────┐      ┌──────────────────┐       │
│  │  Yahoo Client    │      │ Expired Product  │       │
│  │  + Filtering     │◄─────┤    Manager       │       │
│  └──────────────────┘      └──────────────────┘       │
│           │                                             │
│           ▼                                             │
│  ┌──────────────────┐      ┌──────────────────┐       │
│  │  Sync Manager    │◄─────┤    Database      │       │
│  │      V5          │      │  + History       │       │
│  └──────────────────┘      └──────────────────┘       │
│           │                                             │
│           ▼                                             │
│  ┌──────────────────┐      ┌──────────────────┐       │
│  │ Google Sheets    │      │   Dashboard      │       │
│  │   6 Worksheets   │      │   Web UI         │       │
│  └──────────────────┘      └──────────────────┘       │
│                                                          │
└─────────────────────────────────────────────────────────┘
```

### 資料流程

```
1. 過期產品篩選（每周執行）
   ┌─────────────────────────────────────────┐
   │ filter_expired_yahoo_products.py        │
   │  ↓                                      │
   │ 登入 Yahoo API                          │
   │  ↓                                      │
   │ 下載所有產品 (22,050)                   │
   │  ↓                                      │
   │ 逐一檢查 Listing endTs                  │
   │  ↓                                      │
   │ 分類：8,795 過期 + 13,255 上架中        │
   │  ↓                                      │
   │ 輸出 yahoo_expired_products.json        │
   └─────────────────────────────────────────┘

2. 每日同步流程
   ┌─────────────────────────────────────────┐
   │ InventorySync_V5.exe                    │
   │  ↓                                      │
   │ 載入過期產品列表                         │
   │  ↓                                      │
   │ 下載三平台庫存（過濾 Yahoo 過期產品）    │
   │  ↓                                      │
   │ 儲存到資料庫                             │
   │  ↓                                      │
   │ 產生 Y&M 比對表                         │
   │  ↓                                      │
   │ 執行庫存同步                             │
   │  ↓                                      │
   │ 更新 Google Sheets                      │
   │  ↓                                      │
   │ 匯出 Dashboard 資料                     │
   └─────────────────────────────────────────┘
```

---

## 📁 檔案結構

### 原始碼結構
```
src/
├── expired_product_manager.py  # 過期產品管理器
├── yahoo_client.py             # Yahoo API 客戶端（整合過濾）
├── pchome_client.py            # PChome API 客戶端
├── momo_client.py              # MOMO API 客戶端
├── database.py                 # 資料庫管理（新增歷史表）
├── sheets_client.py            # Google Sheets 客戶端
└── sync_manager_v5.py          # V5 同步管理器

工具腳本/
├── filter_expired_yahoo_products.py  # 過期產品篩選工具
├── run_v5.py                         # V5 主程式入口
└── build_v5.bat                      # V5 打包腳本

設定檔/
└── config/
    ├── credentials.json          # API 憑證
    └── credentials_template.json # 憑證範本

網頁介面/
└── dashboard/
    └── index.html               # 儀表板網頁

資料檔/
├── yahoo_expired_products.json  # 過期產品列表
└── inventory.db                 # 本地資料庫
```

### 打包後結構
```
InventorySync_V5/
├── InventorySync_V5.exe         # 主程式
├── config/                      # 設定檔
├── dashboard/                   # 網頁介面
├── yahoo_expired_products.json  # 過期產品列表
├── _internal/                   # Python 依賴庫
├── README_V5.txt               # 使用說明
└── VERSION_V5.txt              # 版本資訊
```

---

## 🔧 核心組件詳解

### 1. ExpiredProductManager

**檔案**: `src/expired_product_manager.py`

**功能**: 管理 Yahoo 過期產品列表

**主要方法**:
```python
class ExpiredProductManager:
    def __init__(self, json_path='yahoo_expired_products.json'):
        """初始化，載入過期產品列表"""
        
    def is_expired(self, part_no):
        """檢查產品是否已過期"""
        
    def is_active(self, part_no):
        """檢查產品是否上架中"""
        
    def get_statistics(self):
        """取得統計資訊"""
```

**資料結構**:
```python
{
    "expired_products": [
        {
            "part_no": "2520290-C9",
            "name": "產品名稱",
            "listing_ids": ["123456"],
            "end_ts": "2024-11-15T23:59:59Z"
        }
    ],
    "active_products": [
        {
            "part_no": "2530011-05",
            "name": "產品名稱",
            "listing_ids": ["789012"]
        }
    ],
    "summary": {
        "total_products": 22050,
        "expired_count": 8795,
        "active_count": 13255
    }
}
```

### 2. Yahoo Client（整合過濾）

**檔案**: `src/yahoo_client.py`

**關鍵更新**:
```python
class YahooClient:
    def __init__(self, config):
        # 初始化過期產品管理器
        self.expired_manager = ExpiredProductManager()
        
    def get_inventory(self, filter_expired=True):
        """
        獲取庫存
        
        Args:
            filter_expired: 是否過濾過期產品（預設 True）
        """
        products = self._fetch_all_products()
        
        if filter_expired:
            # 過濾過期產品
            filtered = []
            for p in products:
                part_no = p.get('part_no')
                if not self.expired_manager.is_expired(part_no):
                    filtered.append(p)
            
            logger.info(f"過濾前: {len(products)} 個產品")
            logger.info(f"過濾後: {len(filtered)} 個產品")
            return filtered
        
        return products
    
    def _extract_spec_from_name(self, name):
        """從產品名稱提取規格"""
        if '-' in name:
            spec = name.split('-')[-1].strip()
            return f"/{spec}"
        return ""
```

### 3. Database（新增歷史追蹤）

**檔案**: `src/database.py`

**新增表格**:
```sql
-- 庫存歷史追蹤表
CREATE TABLE inventory_history (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    platform TEXT NOT NULL,
    sku TEXT NOT NULL,
    quantity INTEGER NOT NULL,
    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 產品同步追蹤表
CREATE TABLE product_sync_tracking (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    sync_date DATE NOT NULL,
    sync_type TEXT NOT NULL,
    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**新增方法**:
```python
def get_last_quantity(self, platform, sku):
    """取得上次記錄的庫存數量"""
    
def update_last_quantity(self, platform, sku, quantity):
    """更新庫存歷史記錄"""
    
def is_product_synced_today(self):
    """檢查今天是否已執行過產品同步"""
    
def record_product_sync(self, sync_type='full'):
    """記錄產品同步執行"""
    
def get_platform_inventory_list(self, platform):
    """取得指定平台的所有庫存記錄"""
```

### 4. Sync Manager V5

**檔案**: `src/sync_manager_v5.py`

**同步流程**:
```python
def run_sync(self):
    """執行同步"""
    
    # 1. 下載三平台產品資料（Yahoo 自動過濾過期產品）
    yahoo_inv = self.yahoo.get_inventory(filter_expired=True)
    pchome_inv = self.pchome.get_inventory()
    momo_inv = self.momo.get_inventory()
    
    # 2. 處理並儲存到資料庫
    self._process_inventory(yahoo_inv, 'Yahoo')
    self._process_inventory(pchome_inv, 'PChome')
    self._process_inventory(momo_inv, 'MOMO')
    
    # 3. 更新 Google Sheets
    self.sheets.update_platform_inventory('Yahoo', yahoo_inv)
    self.sheets.update_platform_inventory('PChome', pchome_inv)
    self.sheets.update_platform_inventory('MOMO', momo_inv)
    
    # 4. 產生 Y&M 比對表
    comparison_data = self._generate_ym_comparison()
    self.sheets.update_ym_comparison(comparison_data)
    
    # 5. 產生跨平台比對表
    comparison_matrix = self._generate_stock_comparison(...)
    self.sheets.update_comparison_report(comparison_matrix)
    
    # 6. 執行庫存同步
    sync_count = self._sync_inventory_quantities(comparison_data)
    
    # 7. 匯出 Dashboard 資料
    self._export_dashboard_data(...)
```

---

## 📊 Google Sheets 結構

### 工作表清單

1. **Yahoo_Inventory**
   ```
   SKU | Name | Spec | Quantity | Part No | Last Updated
   ```

2. **PChome_Inventory**
   ```
   SKU | Name | Spec | Quantity | Part No | Last Updated
   ```

3. **MOMO_Inventory**
   ```
   SKU | Name | Spec | Quantity | Part No | Last Updated
   ```

4. **Stock_Comparison**
   ```
   SKU | Name | Spec | Min Qty | Yahoo Qty | PChome Qty | MOMO Qty | Status | Last Updated
   ```

5. **Sync_Log**
   ```
   Timestamp | SKU | Name | Spec | Platform | Action | Quantity Change | Status | Message
   ```

6. **Y&M_庫存比對**（新增）
   ```
   Part No | Spec | Product Name | Yahoo SKU | Yahoo Qty | MOMO SKU | MOMO Qty | Qty Diff | Status | Last Updated
   ```

---

## 🔄 庫存同步邏輯

### 總量確定論

**原則**: 基於變化量同步，而非直接覆蓋

**實作邏輯**:
```python
def _sync_inventory_quantities(self, comparison_data):
    for item in comparison_data:
        if item['Status'] == '不一致':
            # 取得上次記錄的數量
            last_y_qty = self.db.get_last_quantity('Yahoo', item['Yahoo_SKU'])
            last_m_qty = self.db.get_last_quantity('MOMO', item['MOMO_SKU'])
            
            current_y_qty = item['Yahoo_Qty']
            current_m_qty = item['MOMO_Qty']
            
            # 判斷哪個平台有變動
            y_changed = (last_y_qty is not None and current_y_qty != last_y_qty)
            m_changed = (last_m_qty is not None and current_m_qty != last_m_qty)
            
            if y_changed and not m_changed:
                # Yahoo 有變動，同步到 MOMO
                diff = current_y_qty - last_y_qty
                new_m_qty = current_m_qty + diff
                self.momo.update_inventory(item['MOMO_SKU'], new_m_qty)
                
            elif m_changed and not y_changed:
                # MOMO 有變動，同步到 Yahoo
                diff = current_m_qty - last_m_qty
                new_y_qty = current_y_qty + diff
                self.yahoo.update_inventory(item['Yahoo_SKU'], new_y_qty)
```

**範例場景**:

| 場景 | 上次 Y | 上次 M | 現在 Y | 現在 M | 動作 | 結果 Y | 結果 M |
|------|--------|--------|--------|--------|------|--------|--------|
| Y 賣出 1 個 | 10 | 10 | 9 | 10 | M -1 | 9 | 9 |
| M 賣出 2 個 | 10 | 10 | 10 | 8 | Y -2 | 8 | 8 |
| Y 補貨 5 個 | 5 | 5 | 10 | 5 | M +5 | 10 | 10 |
| 兩邊都變 | 10 | 10 | 8 | 9 | 警告 | 8 | 9 |

---

## ⚙️ 設定檔

### credentials.json
```json
{
  "yahoo": {
    "vendor_id": "your_vendor_id",
    "encrypt_key": "your_encrypt_key",
    "encrypt_iv": "your_encrypt_iv"
  },
  "pchome": {
    "vendor_id": "your_vendor_id",
    "encrypt_key": "your_encrypt_key",
    "encrypt_iv": "your_encrypt_iv"
  },
  "momo": {
    "vendor_id": "your_vendor_id",
    "encrypt_key": "your_encrypt_key",
    "encrypt_iv": "your_encrypt_iv"
  },
  "google_sheets": {
    "credentials_file": "config/google_credentials.json",
    "sheet_name": "三平台庫存同步"
  },
  "database": {
    "path": "inventory.db"
  },
  "system": {
    "safety_stock": 0
  }
}
```

---

## 🚀 使用指南

### 安裝部署

1. **複製檔案**
   ```
   複製整個 InventorySync_V5 資料夾到目標電腦
   ```

2. **設定 API 憑證**
   ```
   編輯 config/credentials.json
   填入各平台的 API 憑證
   ```

3. **確認過期產品列表**
   ```
   確認 yahoo_expired_products.json 存在
   ```

### 每日使用

```bash
# 執行同步
InventorySync_V5.exe

# 查看日誌
notepad sync_v5.log

# 開啟儀表板
dashboard/index.html
```

### 每周維護

```bash
# 重新篩選過期產品（約 5-6 小時）
python filter_expired_yahoo_products.py

# 檢查結果
notepad dist/yahoo_expired_products.json
```

---

## 📈 效能指標

### 執行時間
- **完整同步**: 約 10 分鐘
- **過期產品篩選**: 約 5-6 小時（每周一次）

### 資料量
- **Yahoo 產品**: 13,255 個（過濾後）
- **PChome 產品**: 約 1,000 個
- **MOMO 產品**: 約 850 個
- **資料庫大小**: 約 50 MB

### API 調用
- **Yahoo**: 13,255 次（減少 39.9%）
- **PChome**: 1,000 次
- **MOMO**: 850 次

---

## 🐛 疑難排解

### 常見問題

**Q1: 找不到過期產品檔案**
```
錯誤: 過期產品檔案不存在: yahoo_expired_products.json
解決: 執行 filter_expired_yahoo_products.py 產生檔案
```

**Q2: Google Sheets 連線失敗**
```
錯誤: Google Sheets authentication failed
解決: 檢查 config/google_credentials.json 是否正確
```

**Q3: 資料庫錯誤**
```
錯誤: Database initialization failed
解決: 刪除 inventory.db 重新執行（會自動建立）
```

### 日誌分析

**正常執行日誌**:
```
2025-12-03 12:00:00 - INFO - Inventory Sync System V5 Starting...
2025-12-03 12:00:01 - INFO - Database initialized successfully.
2025-12-03 12:00:01 - INFO - 已載入過期產品管理器:
2025-12-03 12:00:01 - INFO -   - 已過期產品: 8795 個
2025-12-03 12:00:01 - INFO -   - 上架中產品: 13255 個
2025-12-03 12:00:02 - INFO - Authenticated with Google Sheets successfully.
2025-12-03 12:00:02 - INFO - Starting sync process...
2025-12-03 12:00:02 - INFO - Fetching inventory from platforms...
2025-12-03 12:05:00 - INFO - Downloaded: Yahoo=13255, PChome=1000, MOMO=850
2025-12-03 12:10:00 - INFO - Sync process completed successfully.
```

---

## 📚 參考資料

### API 文件
- Yahoo Supplier API
- PChome Vendor API
- MOMO Seller API
- Google Sheets API v4

### 相關文件
- `版本演進歷史.md` - 版本演進記錄
- `YAHOO_過期產品過濾說明.md` - 過期產品過濾詳細說明
- `README_V5.txt` - 使用者手冊

---

**文件版本**: 1.0  
**最後更新**: 2025-12-03  
**作者**: Antigravity AI Assistant
