# 對話記錄 - Yahoo 過期產品過濾 (2025-12-02)

## 日期
2025年12月2日

## 主要目標
找到完整適合比對的 Yahoo 產品清單，解決「多筆記錄 (Y:2, M:1)」問題

## 問題分析

### 核心問題
同一個供應商料號（Part No）+ 規格（Spec）的商品，在 Yahoo 可能有多個賣場記錄：
- 一個上架中（endTs 在未來）
- 一個已下架（endTs 已過期）

這導致在與 MOMO 比對時出現重複記錄。

### 解決方案
使用 Yahoo Listing API 的 `endTs` 欄位來過濾已過期的產品。

## 工作成果

### 1. 發現 Yahoo Listing API 欄位
通過測試發現 Yahoo Listing API 提供以下關鍵欄位：
```json
{
  "endTs": "2035-11-30T03:55:59Z",  // 結束時間（UTC）
  "startTs": "...",                  // 開始時間
  "status": "normal"                 // 狀態
}
```

### 2. 建立獨立過濾腳本
**檔案**: `filter_expired_yahoo_products.py`

**功能**:
- 登入 Yahoo API
- 抓取所有產品（22,050 個）
- 對每個產品檢查 Listing API 的 `endTs` 欄位
- 比對系統時間，過濾掉已過期的產品
- 輸出結果到 JSON 檔案

**執行時間**: 約 5.5 小時（因需為每個產品調用 Listing API）

### 3. 最終統計結果

**總產品數**: 22,050
- **已過期產品**: 8,795 (39.9%)
- **上架中產品**: 13,255 (60.1%)

**關鍵發現**:
- 有 **8,795 個產品已過期**（endTs 早於當前時間）
- 這些產品的 endTs 大多在 2025-11 月初到 12 月初之間
- 這就是造成「多筆記錄 (Y:2, M:1)」問題的根本原因

### 4. 已過期產品範例
```
1. 2520290-C9 - LONGCHAMP 水桶包 (endTs: 2025-12-01T02:44:32Z)
2. 2530011-05 - LONGCHAMP 3D XS (endTs: 2025-12-01T03:20:47Z)
3. 1840602-01 - PRADA x MiuMiu (endTs: 2025-11-05T06:40:00Z)
4. 2540055-07 - miu miu Aventure (endTs: 2025-11-11T01:07:40Z)
5. 2520080-B3 - TORY BURCH Robinson (endTs: 2025-11-13T02:08:48Z)
```

## 建立的檔案

### 1. 過濾腳本
- **`filter_expired_yahoo_products.py`** - 獨立過濾腳本

### 2. 結果檔案
- **`dist/yahoo_expired_products.json`** - 完整的過期產品列表（JSON 格式）
  - 包含 `expired_products` 陣列（8,795 筆）
  - 包含 `active_products` 陣列（13,255 筆）

### 3. 說明文件
- **`YAHOO_過期產品過濾說明.md`** - 完整的解決方案說明文件

### 4. 其他輔助腳本
- **`update_yahoo_spec.py`** - 更新 Yahoo_Inventory 的 Spec 欄位
- **`compare_yahoo_momo_inventory.py`** - Yahoo vs MOMO 庫存比對
- **`analyze_yahoo_momo_sku.py`** - Yahoo vs MOMO SKU 分析

## 比對結果分析

### Yahoo vs MOMO 比對統計
- **共同的 Part No**: 489 個
- **異常情況（MOMO 1個，Yahoo 多個）**: 209 筆
- **正常情況（MOMO 1個，Yahoo 1個）**: 275 筆
- **異常的供應商料號數量**: 70 個

### SKU+Spec 比對統計
- **Yahoo 獨有的 SKU+Spec**: 20,031
- **MOMO 獨有的 SKU+Spec**: 854
- **共同的 SKU+Spec**: 281

### 庫存比對結果
- **總比對筆數**: 287
- **庫存一致**: 195 筆（68%）
- **庫存不一致**: 80 筆（28%）
- **多筆記錄**: 12 筆（4%）

## 技術細節

### endTs 過期判斷邏輯
```python
from datetime import datetime

end_time = datetime.strptime(endTs, "%Y-%m-%dT%H:%M:%SZ")
current_time = datetime.utcnow()

if end_time < current_time:
    # 已過期，不納入庫存
    is_expired = True
```

### API 調用策略
- Products API: 獲取產品列表
- Listing API: 獲取每個產品的 endTs
- 總 API 調用次數: 約 44,100 次（22,050 個產品 × 2）

## 遇到的問題

### 1. yahoo_client.py 損壞
在嘗試修改 `yahoo_client.py` 加入 endTs 過濾邏輯時，多次遇到語法錯誤，導致檔案損壞。

**解決方案**: 採用獨立腳本方式，避免修改主程式碼。

### 2. 執行時間過長
由於需要為每個產品調用 Listing API，總執行時間約 5.5 小時。

**未來優化方案**:
- 批次處理
- 快取 endTs 資料
- 只檢查有變動的產品

## 下一步計劃

### 明天（2025-12-03）的工作
1. **製作比對程式**
   - 整合 endTs 過濾邏輯到 V5 版本
   - 只使用 13,255 個上架中的產品進行比對
   - 排除 8,795 個已過期的產品

2. **優化比對邏輯**
   - 使用 Part No + Spec 作為唯一識別碼
   - 確保一對一比對（避免重複）
   - 產生清晰的比對報告

3. **建立 V5 版本**
   - 整合過期產品過濾
   - 優化 API 調用次數
   - 改善執行效率

## 相關檔案位置

```
e:\ANTIGRAVITY\PROJECT\三平台API同步\
├── filter_expired_yahoo_products.py          # 過濾腳本
├── YAHOO_過期產品過濾說明.md                  # 說明文件
├── update_yahoo_spec.py                      # Spec 更新腳本
├── compare_yahoo_momo_inventory.py           # 庫存比對腳本
├── analyze_yahoo_momo_sku.py                 # SKU 分析腳本
└── dist/
    ├── yahoo_expired_products.json           # 過期產品列表
    ├── Y&M_產品規格庫存比較表.xlsx            # 比對結果
    └── Yahoo_MOMO_SKU_Comparison.xlsx        # SKU 比對結果
```

## 總結

今天成功找到了 Yahoo 產品重複的根本原因（已過期的產品仍在系統中），並建立了完整的過濾機制。

**關鍵成果**:
- ✅ 識別出 8,795 個已過期產品
- ✅ 確認 13,255 個上架中產品
- ✅ 建立獨立過濾腳本
- ✅ 產生完整的過期產品列表

**明天目標**:
- 🎯 製作完整的比對程式
- 🎯 整合到 V5 版本
- 🎯 優化執行效率

---
**記錄時間**: 2025-12-02 23:15
**下次提醒**: 2025-12-03 08:00
