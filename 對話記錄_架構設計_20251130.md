# 對話記錄 - 多平台庫存同步系統架構設計

**日期**：2025-11-30  
**主題**：本機執行版庫存同步系統架構規劃與需求確認

---

## 討論摘要

本次對話主要討論了多平台（Yahoo、PChome、MOMO）庫存同步系統的技術架構設計，從最初的概念驗證到最終確定完整的實作方案。

---

## 對話流程

### 1. Git 同步操作

**使用者需求**：同步 Git 上的 RES 儲存庫到本地

**執行動作**：
- 執行 `git pull` 下載遠端變更
- 處理合併衝突：
  - 將本地檔案重新命名加上「(本地)」後綴
  - 接受遠端版本的檔案
- 成功完成合併

**結果**：
- 保留本地版本：`對話記錄_完整版_20251128(本地).md`、`拷貝前檢查清單(本地).md`
- 下載遠端版本：`對話記錄_完整版_20251128.md`、`拷貝前檢查清單.md` 等

---

### 2. 初步架構設想討論

**使用者提出的設想**：
1. 本機操作：用 Python 寫 EXE 來執行庫存比對和增減作業
2. 資料來源：三個平台的 Excel 檔人工下載後放在各自資料夾
3. Google Sheets + Apps Script：連結 API 進行下載和上傳
4. IP 白名單問題：三個平台都需要設定固定 IP

**提出的三個問題**：
1. Excel 檔人工下載後，能否執行 EXE 時在本機計算？
2. Google Sheets + Apps Script 能否連結 API 做下載上傳？
3. IP 白名單前提下，GS 的浮動 IP 是否無法執行？

**回答與分析**：
1. ✅ 本機 Python EXE 處理 Excel 完全可行
2. ⚠️ Google Sheets + Apps Script 理論可行但有限制（執行時間、效能）
3. ❌ **關鍵障礙**：Google Apps Script 使用浮動 IP，無法加入白名單

**推薦方案**：
- 方案 A：本機 Python EXE + 固定 IP
- 方案 B：雲端伺服器 + Python（最佳方案）

---

### 3. 架構方案調整

**使用者確定的方案**：
- 在已設定固定 IP 的辦公室環境電腦執行
- 使用 Python 開發的 EXE
- 本機執行三大功能

**三大核心功能**：

#### 第一：API 下載 + 庫存比對
- API 下載三平台資料
- 本地資料庫操作（SQLite）
- 透過 Python EXE 執行庫存比對和增減計算

#### 第二：API 上傳 + Google Sheets 同步
- 透過 API 上傳至三個平台
- 同時將結果上傳到 Google Sheets

#### 第三：儀表板網頁
- 可在任何電腦上讀取 Google Sheets 資料
- 查看同步歷史和異動歷史

**補強建議**：
1. 錯誤處理與重試機制
2. 排程執行機制（每分鐘執行）
3. 資料一致性保證
4. 監控與告警
5. 安全性（憑證加密、權限控制）

---

### 4. 需求確認與最終方案

**關鍵需求確認**：

#### 同步頻率
- ❌ 不使用自動排程
- ✅ **採用手動執行**（使用者需要時雙擊 EXE）
- 理由：避免 Google Sheets 配額問題，符合實際業務流程

#### 資料庫選擇
- ✅ **SQLite**
- 優點：無需安裝、檔案形式、適合 3-4 位使用者
- 多使用者方案：每台電腦獨立 `.db` 檔案，結果都寫入同一個 Google Sheets

#### 儀表板部署
- ✅ **本地 HTML 檔案**
- 直接雙擊 `index.html` 開啟
- 透過 Google Sheets API 讀取資料
- 可放在共用資料夾

#### 告警方式
- ✅ **Email**
- 使用 SMTP（Gmail/Outlook）
- 執行失敗時自動發送通知

---

## 最終架構設計

### 系統架構圖

```
【辦公室環境 - 3-4 台電腦】
每台電腦：
  - inventory_sync.exe（手動執行）
  - inventory.db（獨立資料庫）
  - credentials.json（共用配置）
  
        ↓ 執行同步
        
【三大平台 API】
  - Yahoo API（AES-256-CBC 加密）
  - PChome API（AES-128-CBC 加密）
  - MOMO API（OTP + 帳密）
  
        ↓ 上傳結果
        
【Google Sheets】
  - 同步歷史
  - 異動歷史
  - 即時庫存
  
        ↓ 讀取資料
        
【儀表板】
  - dashboard.html（本地開啟）
  - 任何電腦/手機都能查看
  
【告警】
  - Email 通知（失敗時）
```

### 執行流程

1. **使用者手動執行** EXE
2. **下載庫存**：從三平台 API 下載最新庫存
3. **本地計算**：在 SQLite 資料庫中進行庫存比對和調整計算
4. **上傳調整**：將調整結果上傳回三平台
5. **記錄結果**：將同步記錄寫入 Google Sheets
6. **失敗告警**：如有錯誤，發送 Email 通知

### 多使用者方案

**方案 A（推薦）**：獨立資料庫 + 共用 Google Sheets
- 每台電腦有獨立的 `inventory.db`
- 所有電腦的執行結果都寫入同一個 Google Sheets
- 無資料庫鎖定問題
- 部署簡單

---

## 技術堆疊

| 層級 | 技術選擇 | 用途 |
|------|---------|------|
| **程式語言** | Python 3.10+ | 核心邏輯開發 |
| **資料庫** | SQLite | 本地資料存儲 |
| **API 整合** | requests, cryptography | 平台 API 呼叫 |
| **執行方式** | 手動執行（雙擊 EXE） | 使用者觸發同步 |
| **雲端同步** | gspread, oauth2client | Google Sheets 整合 |
| **前端** | HTML5, JavaScript, Chart.js | 儀表板網頁 |
| **打包** | PyInstaller | EXE 封裝 |
| **告警** | smtplib | Email 通知 |

---

## 專案實作階段

### 階段一：環境準備與基礎設定 (1-2 天)
- 開發環境建置
- API 憑證準備
- Google Sheets API 設定
- IP 白名單設定

### 階段二：核心功能開發 (5-7 天)
- 本地資料庫設計
- Yahoo/PChome/MOMO API 整合
- 庫存同步核心邏輯
- Google Sheets 整合

### 階段三：錯誤處理與告警機制 (1-2 天)
- 手動執行介面設計
- 錯誤處理與重試機制
- Email 告警機制
- 日誌記錄

### 階段四：儀表板網頁開發 (3-4 天)
- Google Sheets 資料結構設計
- 儀表板前端開發
- 儀表板樣式與互動
- 本地 HTML 檔案部署

### 階段五：測試與優化 (2-3 天)
- 單元測試
- 整合測試
- 效能優化
- 安全性檢查

### 階段六：部署與上線 (1 天)
- EXE 打包
- 部署到 3-4 台電腦
- 文件撰寫
- 正式上線

**預估總時程**：13-19 天

---

## 關鍵決策記錄

### 決策 1：手動執行 vs 自動排程
- **決定**：採用手動執行
- **理由**：
  - 避免 Google Sheets API 配額限制
  - 符合實際業務流程（不需要每分鐘同步）
  - 使用者可控制執行時機

### 決策 2：SQLite vs PostgreSQL
- **決定**：採用 SQLite
- **理由**：
  - 無需安裝額外軟體
  - 適合 3-4 位使用者規模
  - 檔案形式便於備份和遷移

### 決策 3：多使用者資料庫策略
- **決定**：每台電腦獨立 `.db` 檔案
- **理由**：
  - 避免資料庫鎖定問題
  - 部署簡單
  - 結果統一在 Google Sheets 可查看

### 決策 4：儀表板部署方式
- **決定**：本地 HTML 檔案
- **理由**：
  - 無需架設伺服器
  - 任何裝置都能開啟
  - 自動讀取最新 Google Sheets 資料

### 決策 5：告警方式
- **決定**：Email
- **理由**：
  - 企業環境常用
  - 可發送給多位管理員
  - 保留完整錯誤記錄

---

## 重要提醒事項

### IP 白名單設定
- 需將辦公室固定 IP 加入三平台白名單
- 確認 3-4 台電腦是否共用同一個對外 IP
- 確認 IP 是否真的為固定 IP

### 多使用者資料庫共用
- 推薦方案 A：每台電腦獨立 `.db`，結果寫入同一個 Google Sheets
- 避免方案 B（共用網路磁碟）的資料庫鎖定問題

### 手動執行模式
- 使用者需要時雙擊 EXE 執行
- 執行完成後自動上傳結果到 Google Sheets
- 失敗時發送 Email 告警

---

## 產出文件

本次對話產出以下文件：

1. **implementation_plan.md** - 完整實作計畫
   - 系統架構設計
   - 六大開發階段詳細說明
   - 技術堆疊與時程規劃
   - 風險評估與驗證計畫

2. **task.md** - 開發任務清單
   - 80+ 個具體任務項目
   - 按階段組織的檢查清單
   - 方便追蹤開發進度

3. **multi_user_deployment_guide.md** - 多使用者部署指南
   - 三種資料庫共用方案比較
   - 詳細部署步驟
   - Email 設定指南
   - 常見問題解答

---

## 下一步行動

1. **確認 IP 白名單**：聯繫網管確認辦公室固定 IP
2. **準備 API 憑證**：向三平台申請或確認現有憑證
3. **設定 Google Cloud**：建立專案並啟用 Sheets API
4. **開始開發**：按照實作計畫進行階段一開發

---

## 技術亮點

1. **混合架構**：結合本機處理的可靠性和雲端展示的便利性
2. **無衝突設計**：多使用者環境下無資料庫鎖定問題
3. **靈活部署**：儀表板可在任何裝置開啟
4. **自動告警**：失敗時立即通知管理員
5. **安全可控**：手動執行，使用者完全掌控同步時機

---

## 附註

- 本系統設計充分考慮了企業環境的實際需求
- 技術選型以穩定性和易用性為優先
- 預留了後續擴充的空間（多使用者權限、手動調整介面等）
- 所有敏感資訊（API 憑證）都有加密保護機制
